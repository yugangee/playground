# 요구사항 문서: 등급/티어 시스템

## 소개

스포츠 플랫폼에 종합 등급/티어 시스템을 구현한다. 대전형 스포츠(축구, 풋살, 농구, 야구, 배구, 아이스하키)의 경기 결과 입력, 점수 산정, 개인/팀 등급 관리, 경기 기록, 골 기록 기능을 포함한다. 동아리형 스포츠(러닝크루, 스노보드, 배드민턴 등)의 활동 완료 기반 점수 반영도 포함한다. 기존 DynamoDB 테이블(playground-users, playground-clubs, playground-club-members)을 확장하고, 신규 테이블(playground-matches, playground-activities)을 추가한다.

## 용어 정의

- **시스템**: 스포츠 플랫폼 백엔드(AWS Lambda + DynamoDB + API Gateway)와 프론트엔드(Next.js)를 포함하는 전체 애플리케이션
- **점수_엔진**: 경기 결과 및 활동 완료 시 개인/팀 포인트를 계산하는 백엔드 로직
- **등급_엔진**: 누적 포인트 기반으로 개인/팀 등급(티어)을 결정하는 백엔드 로직
- **매치_서비스**: 경기 제안, 수락, 결과 입력, 확정 등 매치 라이프사이클을 관리하는 백엔드 서비스
- **활동_서비스**: 동아리형 스포츠의 일정 제안, 참가, 완료를 관리하는 백엔드 서비스
- **주장**: 클럽의 captainEmail 필드에 등록된 사용자로, 경기 결과 입력 권한을 가진 멤버
- **TP**: Team Points, 팀 누적 포인트
- **연승**: 연속 승리 횟수, 무승부 또는 패배 시 0으로 초기화
- **대전형_스포츠**: 축구, 풋살, 농구, 야구, 배구, 아이스하키 등 두 팀이 대결하는 종목
- **동아리형_스포츠**: 러닝크루, 스노보드, 배드민턴 등 승패 없이 활동 참여 기반으로 운영되는 종목
- **팀_관리_페이지**: /team 경로의 프론트엔드 페이지
- **클럽_탐색_페이지**: /clubs 경로의 프론트엔드 페이지
- **마이페이지**: /mypage 경로의 프론트엔드 페이지

## 요구사항

### 요구사항 1: 대전형 스포츠 점수 산정

**사용자 스토리:** 경기에 참여한 선수로서, 경기 결과에 따라 정확한 포인트를 받고 싶다. 그래야 내 등급이 공정하게 반영된다.

#### 인수 조건

1. WHEN 대전형 스포츠 경기가 확정(confirmed) 상태가 되면, THE 점수_엔진 SHALL 참여한 모든 선수에게 참여 포인트 3점을 부여한다
2. WHEN 경기 결과가 승리이면, THE 점수_엔진 SHALL 승리 팀 선수에게 추가 보너스 4점을 부여하여 합계 7점을 반영한다
3. WHEN 경기 결과가 무승부이면, THE 점수_엔진 SHALL 양쪽 팀 선수에게 추가 보너스 1점을 부여하여 합계 4점을 반영한다
4. WHEN 경기 결과가 패배이면, THE 점수_엔진 SHALL 패배 팀 선수에게 추가 보너스 0점을 부여하여 합계 3점을 반영한다
5. WHEN 선수의 연속 승리 횟수가 N(N≥2)이면, THE 점수_엔진 SHALL 해당 경기 승리 포인트에 (N-1)점의 연승 보너스를 추가한다
6. WHEN 경기 결과가 무승부 또는 패배이면, THE 점수_엔진 SHALL 해당 선수의 연승 횟수를 0으로 초기화한다
7. THE 점수_엔진 SHALL 팀(TP)에도 개인과 동일한 점수 규칙(참여+3, 승리+4, 무승부+1, 패배+0, 연승 보너스)을 적용한다

### 요구사항 2: 골 기록 점수

**사용자 스토리:** 골을 넣은 선수로서, 골 기록에 대한 추가 포인트를 받고 싶다. 그래야 개인 기여가 등급에 반영된다.

#### 인수 조건

1. WHEN 확정된 경기에 골 기록이 추가되면, THE 점수_엔진 SHALL 골을 기록한 선수에게 1골당 2점을 부여한다
2. THE 점수_엔진 SHALL 골 기록 포인트를 해당 선수의 종목별 누적 포인트에 합산한다
3. THE 점수_엔진 SHALL 골 기록 포인트를 팀 TP에는 반영하지 않는다

### 요구사항 3: 개인 등급 결정 (축구/풋살)

**사용자 스토리:** 축구/풋살 선수로서, 내 누적 포인트에 따라 등급이 자동으로 결정되길 원한다. 그래야 내 실력 수준을 확인할 수 있다.

#### 인수 조건

1. WHEN 선수의 축구 또는 풋살 누적 포인트가 0~24점이면, THE 등급_엔진 SHALL 해당 선수의 등급을 비기너(B)로 설정한다
2. WHEN 선수의 축구 또는 풋살 누적 포인트가 25~100점이면, THE 등급_엔진 SHALL 해당 선수의 등급을 스타터(S)로 설정한다
3. WHEN 선수의 축구 또는 풋살 누적 포인트가 101~300점이면, THE 등급_엔진 SHALL 해당 선수의 등급을 아마추어(A)로 설정한다
4. WHEN 선수의 축구 또는 풋살 누적 포인트가 301~700점이면, THE 등급_엔진 SHALL 해당 선수의 등급을 세미프로(SP)로 설정한다
5. WHEN 선수의 축구 또는 풋살 누적 포인트가 701점 이상이면, THE 등급_엔진 SHALL 해당 선수의 등급을 프로(P)로 설정한다
6. WHEN 포인트 변동이 발생하면, THE 등급_엔진 SHALL 즉시 등급을 재계산하여 playground-users 테이블의 ratings 필드를 갱신한다

### 요구사항 4: 팀 등급 결정 (축구/풋살)

**사용자 스토리:** 팀 운영자로서, 팀의 누적 TP에 따라 팀 등급이 자동으로 결정되길 원한다. 그래야 팀의 수준을 확인할 수 있다.

#### 인수 조건

1. WHEN 팀의 누적 TP가 0~50이면, THE 등급_엔진 SHALL 해당 팀의 등급을 루키(Rookie)로 설정한다
2. WHEN 팀의 누적 TP가 51~250이면, THE 등급_엔진 SHALL 해당 팀의 등급을 클럽(Club)으로 설정한다
3. WHEN 팀의 누적 TP가 251~800이면, THE 등급_엔진 SHALL 해당 팀의 등급을 크루(Crew)로 설정한다
4. WHEN 팀의 누적 TP가 801~2000이면, THE 등급_엔진 SHALL 해당 팀의 등급을 엘리트(Elite)로 설정한다
5. WHEN 팀의 누적 TP가 2001 이상이면, THE 등급_엔진 SHALL 해당 팀의 등급을 레전드(Legend)로 설정한다
6. WHEN TP 변동이 발생하면, THE 등급_엔진 SHALL 즉시 팀 등급을 재계산하여 playground-clubs 테이블의 teamRating 필드를 갱신한다

### 요구사항 5: 경기 제안 및 매치 성립

**사용자 스토리:** 팀 주장으로서, 다른 팀에 경기를 제안하고 상대 팀이 수락하면 매치가 성립되길 원한다. 그래야 경기 일정을 잡을 수 있다.

#### 인수 조건

1. WHEN 사용자가 클럽_탐색_페이지에서 상대 팀에 경기 제안 버튼을 클릭하면, THE 매치_서비스 SHALL playground-matches 테이블에 status가 "proposed"인 매치 레코드를 생성한다
2. WHEN 매치가 생성되면, THE 시스템 SHALL 상대 팀 전원에게 경기 제안 알림을 전송한다
3. WHEN 상대 팀이 경기 제안을 수락하면, THE 매치_서비스 SHALL 매치 status를 "scheduled"로 변경한다
4. WHEN 매치가 scheduled 상태가 되면, THE 시스템 SHALL 양쪽 팀 주장 간 채팅방을 자동 생성한다
5. WHEN 상대 팀이 경기 제안을 거절하면, THE 매치_서비스 SHALL 매치 status를 "declined"로 변경한다
6. THE 매치_서비스 SHALL 매치 레코드에 matchId, homeClubId, awayClubId, sport, date, venue, status, createdAt 필드를 저장한다

### 요구사항 6: 경기 결과 입력 및 확정

**사용자 스토리:** 팀 주장으로서, 경기 후 결과를 입력하고 양쪽 결과가 일치하면 자동으로 확정되길 원한다. 그래야 포인트가 정확하게 반영된다.

#### 인수 조건

1. WHILE 매치가 scheduled 상태일 때, WHEN 홈팀 주장이 스코어를 입력하면, THE 매치_서비스 SHALL 매치 status를 "homeSubmitted"로 변경하고 homeScore와 homeSubmittedBy를 저장한다
2. WHILE 매치가 scheduled 상태일 때, WHEN 어웨이팀 주장이 스코어를 입력하면, THE 매치_서비스 SHALL 매치 status를 "awaySubmitted"로 변경하고 awayScore와 awaySubmittedBy를 저장한다
3. WHEN 양쪽 주장이 모두 스코어를 입력하고 양쪽 입력 결과가 일치하면, THE 매치_서비스 SHALL 매치 status를 "confirmed"로 변경하고 confirmedAt을 기록한다
4. WHEN 매치가 confirmed 상태가 되면, THE 점수_엔진 SHALL 양쪽 팀의 모든 멤버와 팀에 포인트를 반영한다
5. WHEN 양쪽 주장이 모두 스코어를 입력하고 양쪽 입력 결과가 불일치하면, THE 매치_서비스 SHALL 매치 status를 "disputed"로 변경하고 양쪽 주장에게 재입력을 요청한다
6. THE 매치_서비스 SHALL 주장(captainEmail)이 아닌 멤버의 스코어 입력 요청을 거부한다
7. IF 주장이 아닌 사용자가 스코어 입력을 시도하면, THEN THE 매치_서비스 SHALL "주장만 결과를 입력할 수 있습니다" 오류 메시지를 반환한다

### 요구사항 7: 골 기록 관리

**사용자 스토리:** 팀 주장으로서, 확정된 경기에 골을 넣은 선수를 기록하고 싶다. 그래야 개인 기여가 정확하게 추적된다.

#### 인수 조건

1. WHILE 매치가 confirmed 상태일 때, WHEN 주장이 골 기록 추가를 요청하면, THE 매치_서비스 SHALL 해당 매치의 goals 배열에 골 기록(scorer 이메일, club ID, count)을 저장한다
2. THE 매치_서비스 SHALL 골 기록 시 팀 멤버 목록에서 복수 선수를 선택할 수 있도록 한다
3. WHEN 골 기록이 저장되면, THE 점수_엔진 SHALL 각 골 기록 선수에게 1골당 2점을 즉시 반영한다
4. THE 매치_서비스 SHALL 주장(captainEmail)이 아닌 멤버의 골 기록 추가 요청을 거부한다

### 요구사항 8: 동아리형 스포츠 활동 관리

**사용자 스토리:** 동아리형 스포츠 팀원으로서, 모임 일정을 제안하고 참가하여 활동 포인트를 받고 싶다. 그래야 동아리 활동도 등급에 반영된다.

#### 인수 조건

1. WHEN 팀 멤버가 팀_관리_페이지에서 활동 일정을 제안하면, THE 활동_서비스 SHALL playground-activities 테이블에 status가 "open"인 활동 레코드를 생성한다
2. THE 활동_서비스 SHALL 활동 레코드에 activityId, clubId, sport, date, venue, createdBy, participants, status, createdAt 필드를 저장한다
3. WHEN 팀 멤버가 활동에 참가 버튼을 클릭하면, THE 활동_서비스 SHALL 해당 멤버의 이메일을 participants 배열에 추가한다
4. WHEN 활동 제안자가 완료 버튼을 클릭하면, THE 활동_서비스 SHALL 활동 status를 "completed"로 변경하고 completedAt을 기록한다
5. WHEN 활동이 completed 상태가 되면, THE 점수_엔진 SHALL 참가자 전원에게 개인 포인트 5점을 부여한다
6. WHEN 활동이 completed 상태가 되면, THE 점수_엔진 SHALL 해당 팀에 TP 5점을 부여한다
7. THE 점수_엔진 SHALL 동아리형 활동에 연승 보너스를 적용하지 않는다

### 요구사항 9: 경기 기록 표시

**사용자 스토리:** 팀원으로서, 팀 관리 페이지에서 최근 경기 기록을 확인하고 싶다. 그래야 팀의 전적을 한눈에 파악할 수 있다.

#### 인수 조건

1. WHEN 사용자가 팀_관리_페이지를 열면, THE 시스템 SHALL 해당 팀의 confirmed 상태 매치 목록을 최신순으로 조회하여 "최근 경기 기록" 섹션에 표시한다
2. THE 시스템 SHALL 각 경기 기록에 상대팀 이름, 스코어(예: 3-1), 결과(승/무/패), 날짜를 표시한다
3. WHEN 경기 기록에 골 기록이 존재하면, THE 시스템 SHALL 해당 경기의 골 기록 선수 목록을 함께 표시한다
4. THE 시스템 SHALL 각 confirmed 경기 기록에 "골 기록 추가" 버튼을 표시한다

### 요구사항 10: 등급 뱃지 UI 표시

**사용자 스토리:** 사용자로서, 개인 등급과 팀 등급을 각 페이지에서 시각적으로 확인하고 싶다. 그래야 내 수준과 팀 수준을 직관적으로 파악할 수 있다.

#### 인수 조건

1. THE 시스템 SHALL 마이페이지에 해당 사용자의 종목별 개인 등급 뱃지를 표시한다
2. THE 시스템 SHALL 팀_관리_페이지에 해당 팀의 팀 등급 뱃지를 표시한다
3. THE 시스템 SHALL 팀_관리_페이지의 멤버 목록에 각 멤버의 개인 등급 뱃지를 표시한다
4. THE 시스템 SHALL 클럽_탐색_페이지의 클럽 카드에 팀 등급 뱃지를 표시한다
5. WHEN 포인트 변동으로 등급이 변경되면, THE 시스템 SHALL 변경된 등급 뱃지를 즉시 반영한다

### 요구사항 11: 경기 제안 섹션 (팀 관리 페이지)

**사용자 스토리:** 팀원으로서, 팀 관리 페이지에서 받은 경기 제안을 확인하고 수락/거절하고 싶다. 그래야 경기 일정을 효율적으로 관리할 수 있다.

#### 인수 조건

1. WHEN 사용자가 팀_관리_페이지를 열면, THE 시스템 SHALL 해당 팀이 어웨이팀인 proposed 상태 매치 목록을 "경기 제안" 섹션에 표시한다
2. THE 시스템 SHALL 각 경기 제안에 상대팀 이름, 제안 날짜를 표시한다
3. WHEN 사용자가 경기 제안의 수락 버튼을 클릭하면, THE 시스템 SHALL 매치_서비스에 수락 요청을 전송한다
4. WHEN 사용자가 경기 제안의 거절 버튼을 클릭하면, THE 시스템 SHALL 매치_서비스에 거절 요청을 전송한다

### 요구사항 12: 멤버별 1:1 채팅

**사용자 스토리:** 팀원으로서, 팀 관리 페이지에서 다른 멤버와 1:1 채팅을 하고 싶다. 그래야 팀 내 소통이 원활해진다.

#### 인수 조건

1. THE 시스템 SHALL 팀_관리_페이지의 멤버 목록에 각 멤버 옆에 채팅 버튼을 표시한다
2. WHEN 사용자가 멤버의 채팅 버튼을 클릭하면, THE 시스템 SHALL 해당 멤버와의 1:1 채팅 페이지(/chat)로 이동한다

### 요구사항 13: 데이터 구조 확장

**사용자 스토리:** 개발자로서, 등급 시스템에 필요한 데이터 구조가 기존 테이블에 추가되고 신규 테이블이 생성되길 원한다. 그래야 등급 시스템이 정상 동작한다.

#### 인수 조건

1. THE 시스템 SHALL playground-users 테이블에 ratings 필드(종목별 tier, points, games, wins, winStreak 포함)를 추가한다
2. THE 시스템 SHALL playground-clubs 테이블에 teamRating 필드(tier, tp, games, wins, winStreak 포함)를 추가한다
3. THE 시스템 SHALL playground-matches 테이블을 matchId를 파티션 키로 생성한다
4. THE 시스템 SHALL playground-activities 테이블을 activityId를 파티션 키로 생성한다
5. THE 시스템 SHALL playground-matches 테이블에 homeClubId-status-index GSI를 생성하여 팀별 매치 조회를 지원한다
6. THE 시스템 SHALL playground-matches 테이블에 awayClubId-status-index GSI를 생성하여 상대팀별 매치 조회를 지원한다
7. THE 시스템 SHALL playground-activities 테이블에 clubId-status-index GSI를 생성하여 팀별 활동 조회를 지원한다

### 요구사항 14: 점수 산정 라운드트립 검증

**사용자 스토리:** 개발자로서, 점수 산정 로직이 정확하게 동작하는지 검증하고 싶다. 그래야 포인트 계산 오류를 방지할 수 있다.

#### 인수 조건

1. FOR ALL 유효한 경기 결과(승리/무승부/패배)와 연승 횟수 조합에 대해, THE 점수_엔진 SHALL 동일한 입력에 대해 항상 동일한 포인트를 산출한다 (결정론적 속성)
2. FOR ALL 경기 결과에 대해, THE 점수_엔진 SHALL 최소 3점(참여 포인트) 이상의 포인트를 산출한다 (하한 속성)
3. FOR ALL 등급 결정에 대해, THE 등급_엔진 SHALL 포인트 증가 시 등급이 하락하지 않는 단조 증가 속성을 유지한다
